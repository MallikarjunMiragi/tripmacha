<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Trip Macha UI</title>
  <link rel="stylesheet" href="chat.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

</head>
<body>
  <div class="container">
    <header>
      <img src="Logo.png" alt="Trip Macha Logo" class="logo" />
      <img src="Profile.png" alt="Profile" id="profileBtn" class="profile-image">
    </header>

    <main>
      <section class="chat-panel" id="chatPanel">
        <!-- Initial bot message -->
        <div class="chat-bubble left">
          <img src="face-Photoroom.png" class="avatar1" />
          <h1> YOUR MACHA</h1>
         
        </div>

        <!-- Messages will be appended here -->
        <input
          type="text"
          class="input-box"
          id="chatInput"
          placeholder="Type your message and press Enter..."
        />
      </section>

      <section class="map-panel" id="myCard">
        
    <div class="map-panel-inner">
        <div class="map-panel-front" >
            <iframe
          src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3912.1404502038496!2d74.78845417481203!3d13.352727507732507!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x3bbcbb6a3843874b%3A0xe43dd720e2fc2170!2sManipal%2C%20Karnataka%2057604!5e0!3m2!1sen!2sin!4v1720005000000!5m2!1sen!2sin"
          allowfullscreen=""
          loading="lazy"
          referrerpolicy="no-referrer-when-downgrade"
        ></iframe>
         <div class="submit-btn"  onclick="flipCard()">FLIP</div>
        </div>
        <div class="map-panel-back">
            <p class="title" id="planSummary">Plan Summary</p>
  <ul id="jsonDisplay"></ul>
        <div class="submit-btn"  onclick="flipCard()">FLIP</div>
    </div>
   
</div>
        
      </section>
    </main>
  </div>
  <div id="profileOverlay" class="popup hidden">
  <div class="profile-card">
  

  <div class="profile-pic">
    <img src="Profile.png" alt="Profile Picture" />
  </div>
  <h2 id="profileName">Loading...</h2>
  <p id="profileDetails">Loading email...</p>
  <p id="emailVerified"></p>
  <button id="verifyBtn" class="reset-btn" style="display: none;">Verify Email</button>
  <button class="reset-btn" disabled>Reset Password</button>
   <button class="reset-btn" id="logout-icon" alt="logout" disabled>Log out</button>
</div>

</div>



<script>
  const input = document.getElementById("chatInput");
  const chatPanel = document.getElementById("chatPanel");

  const token = localStorage.getItem("token");
  let conversationId = sessionStorage.getItem("conversationId") || "";

  function addUserMessage(msg) {
    const userBubble = document.createElement("div");
    userBubble.className = "chat-bubble right";
    userBubble.innerHTML = `
      <div class="bubble">${msg}</div>
      <img src="Profile.png" class="avatar" />
    `;
    chatPanel.insertBefore(userBubble, input);
    chatPanel.scrollTop = chatPanel.scrollHeight;
  }

  function addBotMessage(msg) {
  const botBubble = document.createElement("div");
  botBubble.className = "chat-bubble left";

  if (isTravelPlanJSON(msg)) {
    displayTravelPlan(msg);
    botBubble.innerHTML = `
      <img src="face-Photoroom.png" class="avatar" />
      <div class="bubble">üß≥ Your travel plan is ready! Flip the map to view it.</div>
    `;
  } else {
    botBubble.innerHTML = `
      <img src="face-Photoroom.png" class="avatar" />
      <div class="bubble">${msg}</div>
    `;
  }

  chatPanel.insertBefore(botBubble, input);
  chatPanel.scrollTop = chatPanel.scrollHeight;
}


  

  window.addEventListener("DOMContentLoaded", () => {
    const initialMessage = sessionStorage.getItem("initialMessage");
    const firstReply = sessionStorage.getItem("firstReply");
    

    if (initialMessage ) {
      addUserMessage(initialMessage);

      fetch("https://new-tm.onrender.com/chat/aiagent/latest", {
        method: "POST",
        headers: {
          Accept: "application/json",
          "Content-Type": "application/json",
          Authorization: "Bearer " + token,
        },
        body: JSON.stringify({ message: initialMessage }),
      })
        .then((res) => res.json().then((data) => ({ status: res.status, data })))
        .then(({ status, data }) => {
          if (status === 200) {
            conversationId = data.conversationId;
            sessionStorage.setItem("conversationId", conversationId);
            addBotMessage(data.reply || "No reply received.");
          } else {
            addBotMessage("‚ö†Ô∏è Failed to start conversation.");
          }
        })
        .catch((err) => {
          console.error("Error:", err);
          addBotMessage("‚ö†Ô∏è Network error.");
        });
    } else if (initialMessage && conversationId && firstReply) {
      addUserMessage(initialMessage);

      setTimeout(() => {
        addBotMessage(firstReply);
      }, 500);
    } else {
      setTimeout(() => {
        addBotMessage("Ok tell me what is the planüòÅ");
      }, 500);
    }
  });

  input.addEventListener("keypress", async function (e) {
    if (e.key === "Enter" && input.value.trim() !== "") {
      const msg = input.value.trim();
      input.value = "";
      addUserMessage(msg);
      addShimmerLoader(); 

      try {
        const response = await fetch("https://new-tm.onrender.com/chat/aiagent/latest", {
          method: "POST",
          headers: {
            Accept: "application/json",
            "Content-Type": "application/json",
            Authorization: "Bearer " + token,
          },
          body: JSON.stringify({
            conversationId: conversationId,
            message: msg,
          }),
        });

        const result = await response.json();
        if (response.ok) {
          conversationId = result.conversationId || conversationId;
          sessionStorage.setItem("conversationId", conversationId);
          removeShimmerLoader();
          addBotMessage(result.reply || "ü§ñ No response.");
        } else {
            removeShimmerLoader();
          addBotMessage("‚ùå Error: " + (result.detail || "Something went wrong."));
        }
      } catch (err) {
        console.error("Network error:", err);
        removeShimmerLoader();
        addBotMessage("‚ö†Ô∏è Network error.");
      }
    }

  });
  const profileBtn = document.getElementById("profileBtn");
  const overlay = document.getElementById("profileOverlay");

  profileBtn?.addEventListener("click", (e) => {
    e.preventDefault();
    overlay.classList.remove("hidden");
    fetchProfile();
  });

  overlay?.addEventListener("click", (e) => {
    if (e.target.id === "profileOverlay") {
      overlay.classList.add("hidden");
    }
  });

  async function fetchProfile() {
    const token = localStorage.getItem("token");
    if (!token) {
      window.location.href = "login.html";
    }

    try {
      const response = await fetch("https://new-tm.onrender.com/users/me", {
        method: "GET",
        headers: {
          Accept: "application/json",
          Authorization: "Bearer " + token,
        },
      });

      const result = await response.json();

      if (response.ok) {
        document.getElementById("profileName").innerText = result.full_name || result.username;
        document.getElementById("profileDetails").innerText = result.email;

        const emailStatus = document.getElementById("emailVerified");
        emailStatus.innerText = result.email_verified ? "Email Verified ‚úÖ" : "Email Not Verified ‚ùå";
        emailStatus.style.color = result.email_verified ? "green" : "red";

        const profileCard = document.querySelector(".profile-card");
        let verifyBtn = document.getElementById("verifyEmailBtn");
        if (!result.email_verified && !verifyBtn) {
          verifyBtn = document.createElement("button");
          verifyBtn.id = "verifyEmailBtn";
          verifyBtn.textContent = "Verify Email";
          verifyBtn.className = "reset-btn";
          verifyBtn.style.marginTop = "10px";
          verifyBtn.onclick = () => (window.location.href = "verifyemail.html");
          profileCard.appendChild(verifyBtn);
        }
      } else {
        document.getElementById("profileName").innerText = "Session Expired";
        document.getElementById("profileDetails").innerText = result.detail || "Please login again.";
        document.getElementById("emailVerified").innerText = "";
      }
    } catch (error) {
      console.error("Error fetching profile:", error);
      document.getElementById("profileName").innerText = "Error";
      document.getElementById("profileDetails").innerText = "Unable to load profile.";
      document.getElementById("emailVerified").innerText = "";
    }
  }

  document.getElementById("logoutIcon").addEventListener("click", () => {
    localStorage.removeItem("token");
    sessionStorage.clear();
    window.location.href = "index.html";
  });
  function addShimmerLoader() {
  const loaderBubble = document.createElement("div");
  loaderBubble.className = "chat-bubble left shimmer-reply";
  loaderBubble.innerHTML = `
    <img src="face-Photoroom.png" class="avatar" />
    <div id="container">
      
      <div id="content">
        <div id="content-title" class="shimmer"></div>
        
      </div>
    </div>
  `;
  chatPanel.insertBefore(loaderBubble, input);
  chatPanel.scrollTop = chatPanel.scrollHeight;
}

function removeShimmerLoader() {
  const loader = document.querySelector(".shimmer-reply");
  if (loader) loader.remove();
}

function flipCard() {
      document.getElementById('myCard').classList.toggle('flipped');
    }

function extractJSON(msg) {
  // Remove triple backtick code block if present
  const match = msg.match(/```json\s*([\s\S]*?)```/i);
  return match ? match[1].trim() : msg.trim();
}

function isTravelPlanJSON(msg) {
  try {
    const cleaned = extractJSON(msg);
    const parsed = JSON.parse(cleaned);
    return Array.isArray(parsed) && parsed[0]?.Time && parsed[0]?.Location && parsed[0]?.Activity;
  } catch {
    return false;
  }
}

// Helper: Convert travel plan JSON to HTML list
function formatTravelPlanList(jsonData) {
  return `
    <ul style="text-align: left; font-size: 14px; padding-left: 1rem;">
      ${jsonData.map((step, i) => `
        <li style="margin-bottom: 8px;">
          <strong>${step.Time}</strong> ‚Äî <em>${step.Location}</em><br>
          ${step.Activity}<br>
          <small>üïí Travel: ${step["Travel Time"]} | üß≠ Spend: ${step["Spend Time"]} | üìç ${step.Distance} km</small>
        </li>
      `).join('')}
    </ul>
  `;
}

// Render the plan summary inside the map panel back
function displayTravelPlan(msg) {
  try {
    const cleaned = extractJSON(msg);
    const parsed = JSON.parse(cleaned);
    const backPanel = document.querySelector(".map-panel-back");

    if (backPanel) {
      backPanel.innerHTML = `
        <p class="title">üß≠ Trip Summary</p>
        ${formatTravelPlanList(parsed)}
        <div class="submit-btn" onclick="flipCard()">üîÑ Flip</div>
      `;
    }
  } catch (err) {
    console.error("Failed to parse and display travel plan:", err);
  }
}


</script>




</body>
</html>